---
title: "Clustering"
author: "Amulya Shastry"
date: "2025-11-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ConsensusClusterPlus)
library(tidyverse)
library(dplyr)
library(readxl)
library(tidyverse)
library(factoextra)
library(umap)
library(iheatmapr)
library(qgraph)
library(corpcor)
library(glasso)
library(BDgraph)
library(umap)
library(dendextend)
library(cluster)
library(ggplot2)
library(bayesbio)
library(ggpubr)
library(rstatix)
library(mclust)
library(psych)
library(scales)
library(ggpubr)
library(janitor)
library(fpc)
library(ppcor)
library(circlize)
library(ComplexHeatmap)
library(gtsummary)
```


# Loading all data 

```{r}
#cleaned, filtered, averaged HE scores (not scaled)
HE_scores<-read.csv("../data/cleaned_data_v6.3.csv")
```



# Clustering

```{r}
HE_scores %>% column_to_rownames("X") -> HE_scores2
new_cleaned<-caret::preProcess(HE_scores2, method=c("range"))
HE_scaled_data<-predict(new_cleaned, HE_scores2)

CC_euc_scaled<-ConsensusClusterPlus(t(as.matrix(HE_scaled_data)),maxK=20,reps=1000,pItem=0.8,pFeature=1, title="../figures/Clustering/Euclidean_scaled",clusterAlg="pam",distance="euclidean",seed=14690,plot="png")

saveRDS(CC_euc_scaled, "../figures/Clustering/Euclidean_scaled/CC_euc_scaled.RDS")
write.csv(HE_scaled_data,"../data/Histopathology_cleaned_filtered_scaled_data.csv")

data.frame(CC_euc_scaled[[7]]$consensusClass) %>%
  rownames_to_column("CaseID") %>%
  rename("clust_labs" = "CC_euc_scaled..7...consensusClass") %>%
  write.csv("../data/cluster_labels_for_all_samples.csv")
```


# ICL 

```{r}
icl = calcICL(CC_euc_scaled,title="../figures/Clustering/Euclidean_scaled/ICL",plot="png")

saveRDS(icl,"../figures/Clustering/Euclidean_scaled/ICL/icl.RDS")
```



# Load mouse datasets

```{r}
# Cleaned with all columns

mouse_clean_all_cols<-read.csv("../data/mouse_HE_scores_cleaned_all_columns.csv")

# Cleaned filtered 

mouse_cleaned_dataset3<-read.csv("../data/mouse_HE_scores_cleaned_filtered.csv")
```

# Clustering

```{r}
mouse_cleaned_dataset3 %>% column_to_rownames("X") -> mouse_cleaned_dataset3
new_cleaned<-caret::preProcess(mouse_cleaned_dataset3, method=c("range"))
mouse_HE_scaled<-predict(new_cleaned, mouse_cleaned_dataset3)

mouse_cc_eu_sclaed<-ConsensusClusterPlus(t(as.matrix(mouse_HE_scaled)),maxK=20,reps=1000,pItem=0.8,pFeature=1, title="../figures/Clustering/Mouse",clusterAlg="pam",distance="euclidean",seed=14690,plot="png")
write.csv(mouse_HE_scaled,"../data/Mouse/mouse_HE_scores_cleaned__filtered_scaled.csv")
saveRDS(mouse_cc_eu_sclaed, "../data/Mouse/mouse_cc_eu_scaled.RDS")
```


# ICL 

```{r}
icl = calcICL(mouse_cc_eu_sclaed,title="../figures/Clustering/Mouse/cluster_metrics/ICL/",plot="png")
saveRDS(icl,"../figures/Clustering/Mouse/cluster_metrics/ICL/mouse_icl.RDS")
```













